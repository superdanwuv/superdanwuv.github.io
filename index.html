<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>자막 프리뷰어 - 모바일 최적화</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            color: #e5e5e5;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            /* 모바일 브라우저 주소창 대응 */
            height: -webkit-fill-available;
        }

        .editor-container {
            height: 100vh;
            height: 100svh; /* 최신 브라우저용 가용 높이 */
            display: flex;
            flex-direction: column;
        }

        /* PC 버전 (화면이 넓을 때) */
        @media (min-width: 768px) {
            .editor-container {
                flex-direction: row;
            }
            .input-section {
                width: 380px;
                height: 100% !important;
                border-right: 1px solid #404040;
                border-bottom: none;
            }
        }

        .input-section {
            background-color: #262626;
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            z-index: 20;
            /* 모바일에서 입력창 높이를 조금 줄여 미리보기 공간 확보 */
            height: 35%; 
            border-bottom: 1px solid #404040;
            flex-shrink: 0;
        }

        .preview-section {
            flex-grow: 1;
            background-color: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            /* 모바일에서 아래쪽 여백 확보 */
            padding-bottom: env(safe-area-inset-bottom);
        }

        textarea {
            flex-grow: 1;
            background-color: #121212;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #404040;
            resize: none;
            outline: none;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        #subtitle-display {
            color: white;
            font-size: 1.4rem; /* 모바일에서 약간 작게 시작 */
            text-align: center;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 1);
            max-width: 90%;
            line-height: 1.4;
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: pre-wrap;
            font-weight: 700;
            z-index: 5;
            margin-bottom: 2rem; /* 컨트롤바와 겹치지 않게 */
        }

        @media (min-width: 768px) {
            #subtitle-display {
                font-size: 2.5rem;
                margin-bottom: 0;
            }
        }

        :fullscreen #subtitle-display {
            font-size: 6vw;
        }

        /* 컨트롤바 위치 및 크기 조정 */
        .controls {
            position: absolute;
            bottom: 1rem;
            background: rgba(45, 45, 45, 0.9);
            padding: 0.5rem 0.8rem;
            border-radius: 12px;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            width: 92%;
            max-width: 480px;
            justify-content: space-between;
            z-index: 15;
        }

        .preview-section.hide-cursor .controls {
            opacity: 0;
            pointer-events: none;
        }

        .time-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            color: #fbbf24;
            min-width: 60px;
            text-align: right;
        }

        /* 터치 영역 최적화 */
        button {
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>

<div class="editor-container">
    <!-- 자막 편집 섹션 -->
    <div class="input-section">
        <div class="flex justify-between items-center mb-1">
            <h1 class="text-sm font-bold text-indigo-400">Subtitle Editor</h1>
            <div id="parse-status" class="text-[10px] text-gray-400 bg-black/30 px-2 py-0.5 rounded-full">
                <span class="status-dot bg-yellow-500"></span> 대기 중
            </div>
        </div>
        
        <textarea id="vtt-input" spellcheck="false" placeholder="여기에 자막을 붙여넣으세요...">WEBVTT

1
00:00:00.500 --> 00:00:02.500

모바일 레이아웃이
최적화되었습니다.

2
00:00:03.000 --> 00:00:06.000

이제 버튼들이 화면 안에
잘 보일 거예요!</textarea>

        <div class="mt-2">
            <button id="apply-btn" class="w-full bg-indigo-600 active:bg-indigo-800 text-white py-2 rounded-lg font-bold text-sm shadow-md transition-colors">
                적용하기
            </button>
        </div>
    </div>

    <!-- 미리보기 섹션 -->
    <div class="preview-section" id="fullscreen-target">
        <div id="subtitle-display"></div>

        <div class="controls" id="ui-controls">
            <!-- 재생 버튼 -->
            <button id="play-pause" class="hover:text-indigo-400">
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                    <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                </svg>
                <svg id="pause-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
                </svg>
            </button>
            
            <!-- 진행 바 -->
            <input type="range" id="seek-bar" class="accent-indigo-500" value="0" step="0.01" min="0">
            
            <!-- 시간 정보 -->
            <div class="time-display" id="time-display">00:00.0</div>
            
            <!-- 전체화면 -->
            <button id="fullscreen-btn" class="hover:text-indigo-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    const vttInput = document.getElementById('vtt-input');
    const subtitleDisplay = document.getElementById('subtitle-display');
    const playPauseBtn = document.getElementById('play-pause');
    const seekBar = document.getElementById('seek-bar');
    const timeDisplay = document.getElementById('time-display');
    const applyBtn = document.getElementById('apply-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const fullscreenTarget = document.getElementById('fullscreen-target');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const statusDot = document.querySelector('.status-dot');
    const statusText = document.getElementById('parse-status');

    let cues = [];
    let currentTime = 0;
    let isPlaying = false;
    let lastTimestamp = 0;
    let maxTime = 10;
    let hideTimer;

    // 자막 파싱 함수 (강화형)
    function parseSubtitlesRobust(text) {
        const lines = text.split('\n');
        const results = [];
        let currentCue = null;
        const timeRegex = /(\d{2}:\d{2}:\d{2}[.,]\d{3}) --> (\d{2}:\d{2}:\d{2}[.,]\d{3})/;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            const timeMatch = line.match(timeRegex);

            if (timeMatch) {
                if (currentCue) results.push(currentCue);
                currentCue = {
                    start: timeToSeconds(timeMatch[1]),
                    end: timeToSeconds(timeMatch[2]),
                    text: ""
                };
            } else if (currentCue && line !== "") {
                if (!/^\d+$/.test(line) && line.toUpperCase() !== 'WEBVTT') {
                    currentCue.text += (currentCue.text ? "\n" : "") + line;
                }
            }
        }
        if (currentCue) results.push(currentCue);
        return results.filter(c => c.text !== "").sort((a, b) => a.start - b.start);
    }

    function timeToSeconds(timeStr) {
        const normalized = timeStr.replace(',', '.');
        const parts = normalized.split(':');
        if (parts.length < 3) return 0;
        return (parseInt(parts[0]) * 3600) + (parseInt(parts[1]) * 60) + parseFloat(parts[2]);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = (seconds % 60).toFixed(1);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(4, '0')}`;
    }

    function updateDisplay() {
        const activeCue = cues.find(cue => currentTime >= cue.start && currentTime <= cue.end);
        
        if (activeCue) {
            if (subtitleDisplay.innerHTML !== activeCue.text) {
                subtitleDisplay.innerHTML = activeCue.text;
                subtitleDisplay.style.opacity = 1;
            }
        } else {
            subtitleDisplay.style.opacity = 0;
        }
        timeDisplay.innerText = formatTime(currentTime);
        seekBar.value = currentTime;
    }

    function animate(timestamp) {
        if (!isPlaying) return;
        if (!lastTimestamp) lastTimestamp = timestamp;
        const delta = (timestamp - lastTimestamp) / 1000;
        lastTimestamp = timestamp;

        currentTime += delta;
        if (currentTime > maxTime) {
            currentTime = 0;
            isPlaying = false;
            updatePlayStatus();
        }
        updateDisplay();
        requestAnimationFrame(animate);
    }

    function updatePlayStatus() {
        if (isPlaying) {
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
        } else {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
        }
    }

    function togglePlay() {
        if (cues.length === 0) return;
        isPlaying = !isPlaying;
        updatePlayStatus();
        if (isPlaying) {
            lastTimestamp = 0;
            requestAnimationFrame(animate);
        }
    }

    // 모바일 전체화면 처리
    fullscreenBtn.onclick = () => {
        if (!document.fullscreenElement) {
            if (fullscreenTarget.requestFullscreen) {
                fullscreenTarget.requestFullscreen();
            } else if (fullscreenTarget.webkitRequestFullscreen) {
                fullscreenTarget.webkitRequestFullscreen(); // iOS/Safari 대응
            }
        } else {
            document.exitFullscreen();
        }
    };

    playPauseBtn.onclick = (e) => {
        e.stopPropagation();
        togglePlay();
    };

    seekBar.oninput = (e) => {
        currentTime = parseFloat(e.target.value);
        updateDisplay();
    };

    applyBtn.onclick = () => {
        const text = vttInput.value;
        const newCues = parseSubtitlesRobust(text);
        
        if (newCues.length > 0) {
            cues = newCues;
            maxTime = Math.max(...cues.map(c => c.end)) + 1;
            seekBar.max = maxTime;
            
            statusDot.className = "status-dot bg-green-500";
            statusText.innerHTML = `<span class="status-dot bg-green-500"></span> ${cues.length}개 로드됨`;
            
            applyBtn.innerText = "적용 완료";
            applyBtn.classList.replace('bg-indigo-600', 'bg-green-600');
            setTimeout(() => {
                applyBtn.innerText = "적용하기";
                applyBtn.classList.replace('bg-green-600', 'bg-indigo-600');
            }, 1000);
            updateDisplay();
        } else {
            statusDot.className = "status-dot bg-red-500";
            statusText.innerHTML = `<span class="status-dot bg-red-500"></span> 자막 형식 확인 필요`;
        }
    };

    // 화면 터치 시 컨트롤바 표시/숨김 (전체화면 모드 등에서 유용)
    fullscreenTarget.onclick = () => {
        fullscreenTarget.classList.remove('hide-cursor');
        clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
            if (isPlaying) fullscreenTarget.classList.add('hide-cursor');
        }, 3000);
    };

    // 키보드 단축키
    document.addEventListener('keydown', (e) => {
        if (document.activeElement === vttInput) return;
        if (e.code === 'Space') {
            e.preventDefault();
            togglePlay();
        }
    });

    // 초기 실행
    window.onload = () => {
        applyBtn.click();
    };
</script>

</body>
</html>


