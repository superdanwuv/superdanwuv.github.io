<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>자막 프리뷰어 - 파싱 강화</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            color: #e5e5e5;
            margin: 0;
            overflow: hidden;
        }

        .editor-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .editor-container {
                flex-direction: row;
            }
            .input-section {
                width: 400px;
                height: 100%;
                border-right: 1px solid #404040;
                border-bottom: none;
            }
        }

        .input-section {
            background-color: #262626;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            z-index: 10;
            height: 40%;
            border-bottom: 1px solid #404040;
        }

        .preview-section {
            flex-grow: 1;
            background-color: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        textarea {
            flex-grow: 1;
            background-color: #121212;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #404040;
            resize: none;
            outline: none;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        #subtitle-display {
            color: white;
            font-size: 1.8rem;
            text-align: center;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 1);
            max-width: 90%;
            line-height: 1.4;
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: pre-wrap;
            font-weight: 700;
        }

        @media (min-width: 768px) {
            #subtitle-display {
                font-size: 3rem;
            }
        }

        :fullscreen #subtitle-display {
            font-size: 6vw;
        }

        .controls {
            position: absolute;
            bottom: 1.5rem;
            background: rgba(40, 40, 40, 0.85);
            padding: 0.6rem 1rem;
            border-radius: 9999px;
            display: flex;
            gap: 1rem;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: opacity 0.3s;
            width: 90%;
            max-width: 500px;
            justify-content: space-between;
        }

        .preview-section.hide-cursor .controls {
            opacity: 0;
        }

        .time-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            color: #fbbf24;
            min-width: 65px;
            text-align: right;
        }

        button:active {
            transform: scale(0.92);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div class="editor-container">
    <div class="input-section">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-lg font-bold text-indigo-400">Subtitle Editor</h1>
            <div id="parse-status" class="text-[10px] text-gray-400 bg-black/20 px-2 py-1 rounded-full">
                <span class="status-dot bg-yellow-500"></span> 대기 중
            </div>
        </div>
        
        <textarea id="vtt-input" spellcheck="false" placeholder="자막을 입력하세요...">WEBVTT

1
00:00:00.583 --> 00:00:01.666

<b>좋은 밤</b>

2
00:00:02.000 --> 00:00:04.500

줄바꿈이 많아도
이제 잘 작동합니다!</textarea>

        <div class="mt-2 flex gap-2">
            <button id="apply-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-lg font-bold text-sm shadow-lg">
                적용하기
            </button>
        </div>
    </div>

    <div class="preview-section" id="fullscreen-target">
        <div id="subtitle-display"></div>

        <div class="controls">
            <button id="play-pause" class="text-white">
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                </svg>
                <svg id="pause-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
                </svg>
            </button>
            
            <input type="range" id="seek-bar" class="accent-indigo-500" value="0" step="0.05">
            
            <div class="time-display" id="time-display">00:00.0</div>
            
            <button id="fullscreen-btn" class="text-white ml-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    const vttInput = document.getElementById('vtt-input');
    const subtitleDisplay = document.getElementById('subtitle-display');
    const playPauseBtn = document.getElementById('play-pause');
    const seekBar = document.getElementById('seek-bar');
    const timeDisplay = document.getElementById('time-display');
    const applyBtn = document.getElementById('apply-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const fullscreenTarget = document.getElementById('fullscreen-target');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const statusDot = document.querySelector('.status-dot');
    const statusText = document.getElementById('parse-status');

    let cues = [];
    let currentTime = 0;
    let isPlaying = false;
    let lastTimestamp = 0;
    let maxTime = 10;
    let hideTimer;

    // 강력한 자막 파서: 엔터가 아무리 많아도 시간대만 발견하면 그룹화함
    function parseSubtitlesRobust(text) {
        const lines = text.split('\n');
        const results = [];
        let currentCue = null;
        
        // 시간 형식을 찾는 정규식 (00:00:00.000 또는 00:00:00,000)
        const timeRegex = /(\d{2}:\d{2}:\d{2}[.,]\d{3}) --> (\d{2}:\d{2}:\d{2}[.,]\d{3})/;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            const timeMatch = line.match(timeRegex);

            if (timeMatch) {
                // 새로운 시간대를 찾으면 이전 자막 저장 후 새 자막 생성
                if (currentCue) results.push(currentCue);
                currentCue = {
                    start: timeToSeconds(timeMatch[1]),
                    end: timeToSeconds(timeMatch[2]),
                    text: ""
                };
            } else if (currentCue && line !== "") {
                // 현재 자막 묶음이 진행 중이고 빈 줄이 아니면 텍스트로 추가
                // 번호만 있는 줄(예: "1")은 제외
                if (!/^\d+$/.test(line) && line.toUpperCase() !== 'WEBVTT') {
                    currentCue.text += (currentCue.text ? "\n" : "") + line;
                }
            }
        }
        if (currentCue) results.push(currentCue);
        
        return results.filter(c => c.text !== "").sort((a, b) => a.start - b.start);
    }

    function timeToSeconds(timeStr) {
        const normalized = timeStr.replace(',', '.');
        const parts = normalized.split(':');
        if (parts.length < 3) return 0;
        return (parseInt(parts[0]) * 3600) + (parseInt(parts[1]) * 60) + parseFloat(parts[2]);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = (seconds % 60).toFixed(1);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(4, '0')}`;
    }

    function updateDisplay() {
        const activeCue = cues.find(cue => currentTime >= cue.start && currentTime <= cue.end);
        
        if (activeCue) {
            if (subtitleDisplay.innerHTML !== activeCue.text) {
                subtitleDisplay.innerHTML = activeCue.text;
                subtitleDisplay.style.opacity = 1;
            }
        } else {
            subtitleDisplay.style.opacity = 0;
        }
        timeDisplay.innerText = formatTime(currentTime);
        seekBar.value = currentTime;
    }

    function step(timestamp) {
        if (!isPlaying) return;
        if (!lastTimestamp) lastTimestamp = timestamp;
        const progress = (timestamp - lastTimestamp) / 1000;
        lastTimestamp = timestamp;

        currentTime += progress;
        if (currentTime > maxTime) {
            currentTime = 0;
            isPlaying = false;
            updatePlayStatus();
        }
        updateDisplay();
        requestAnimationFrame(step);
    }

    function updatePlayStatus() {
        if (isPlaying) {
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
        } else {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
        }
    }

    function togglePlay() {
        if (cues.length === 0) return;
        isPlaying = !isPlaying;
        updatePlayStatus();
        if (isPlaying) {
            lastTimestamp = 0;
            requestAnimationFrame(step);
        }
    }

    fullscreenBtn.onclick = () => {
        if (!document.fullscreenElement) {
            fullscreenTarget.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    };

    playPauseBtn.onclick = togglePlay;

    seekBar.oninput = (e) => {
        currentTime = parseFloat(e.target.value);
        updateDisplay();
    };

    applyBtn.onclick = () => {
        const text = vttInput.value;
        const newCues = parseSubtitlesRobust(text);
        
        if (newCues.length > 0) {
            cues = newCues;
            maxTime = Math.max(...cues.map(c => c.end)) + 1;
            seekBar.max = maxTime;
            
            statusDot.className = "status-dot bg-green-500";
            statusText.innerHTML = `<span class="status-dot bg-green-500"></span> ${cues.length}개 로드됨`;
            
            applyBtn.innerText = "적용 완료";
            applyBtn.classList.replace('bg-indigo-600', 'bg-green-600');
            setTimeout(() => {
                applyBtn.innerText = "적용하기";
                applyBtn.classList.replace('bg-green-600', 'bg-indigo-600');
            }, 1000);
            updateDisplay();
        } else {
            statusDot.className = "status-dot bg-red-500";
            statusText.innerHTML = `<span class="status-dot bg-red-500"></span> 형식 오류 (시간 체크)`;
        }
    };

    // 초기 적용
    applyBtn.click();
</script>

</body>
</html>

